<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>トタンガラガラ</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body { margin:0; background:#0c0f14; }
    canvas { display:block; margin:auto; touch-action:none; }
  </style>
</head>
<body>

<script>
class GaragaraScene extends Phaser.Scene {
  constructor(){ super('main'); }

  create(){
    this.graphics = this.add.graphics();
    this.scrollX = 0;

    // ==== AudioContext をタッチ操作で初期化 ====
    this.audioCtx = null;
    this.noiseBuf = null;
    this.resumePromise = null;

    this.input.on('pointerdown', ()=>{
      this.playNoise();
    });

    this.input.on('pointermove', p=>{
      if (p.isDown) this.playNoise();
    });
  }

  update(){
    this.scrollX += 2; // トタンが流れる速度
    this.drawTin();
  }

  drawTin(){
    this.graphics.clear();
    this.graphics.lineStyle(2, 0x999999, 1);
    const baseY = this.sys.game.config.height * 0.6;
    for (let i=0;i<this.sys.game.config.width;i+=6){
      const yy = baseY + Math.sin((i+this.scrollX)/15)*8;
      this.graphics.lineBetween(i, yy, i+6, yy);
    }
  }

  playNoise(){
    this.ensureAudio().then(()=>{
      if (!this.audioCtx || !this.noiseBuf || this.audioCtx.state !== 'running') return;
      const src = this.audioCtx.createBufferSource();
      src.buffer = this.noiseBuf;
      const gain = this.audioCtx.createGain();
      gain.gain.value = 0.3;
      src.connect(gain).connect(this.audioCtx.destination);
      src.start(0,0,0.05); // 短い「ガラッ」音
    }).catch(()=>{});
  }

  ensureAudio(){
    if (!this.audioCtx) {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return Promise.resolve();
      this.audioCtx = new AudioCtx();
      const buffer = this.audioCtx.createBuffer(1, this.audioCtx.sampleRate, this.audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.25;
      this.noiseBuf = buffer;
    }

    if (this.audioCtx.state === 'running') {
      return Promise.resolve();
    }

    if (!this.resumePromise) {
      this.resumePromise = this.audioCtx.resume()
        .catch(err=>{
          this.resumePromise = null;
          throw err;
        })
        .then(()=>{
          this.resumePromise = null;
        });
    }

    return this.resumePromise;
  }
}

const config = {
  type: Phaser.AUTO,
  width: window.innerWidth,
  height: window.innerHeight,
  backgroundColor: '#0c0f14',
  scene: [GaragaraScene]
};

new Phaser.Game(config);
</script>

</body>
</html>
